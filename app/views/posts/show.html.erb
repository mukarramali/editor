<h1><%= @post.title %></h1>

<textarea id="post_area" data-post-channel="post" data-post-id="<%= @post.id %>"  data-push-code-path="<%= url_for(action: 'update', controller: 'posts') %>"><%= @post.content %></textarea>

<%= link_to 'Back', posts_path %>

<script>
  var pre_val = "";
  var new_val = "";
  $('#post_area').bind('input propertychange', function(){
    new_val = $(this).val();
    if(Math.abs(new_val.length - pre_val.length) > 4)
    {
      pre_val = new_val;
      push();
    }
  });

  function push(){
    post_id = $('#post_area').data("post-id");
    $.ajax({
      url: '/update/'+post_id+'.json',
      data: {
            'content' : $('#post_area').val()
            },
      type: 'post',
      dataType: 'json',
      success: function(data){
        if(data['status'] != true)
          setTimeout(function(){push()}, 5000);
      },
      error: function(xhr, status, error) {
        var err = JSON.parse(xhr.responseText);
        console.log(err.Message);
        setTimeout(function(){push()}, 5000);
      }
    });
  }

</script>